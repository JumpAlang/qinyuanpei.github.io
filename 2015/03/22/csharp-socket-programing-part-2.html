<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>C#中Socket通信编程的异步实现 | 飞鸿踏雪的部落格 | 人生到处知何似，应似飞鸿踏雪泥</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="theme-color" content="#3F51B5">
  
  
  <meta name="keywords" content="Socket,通信,异步">
  <meta name="description" content="&amp;emsp;&amp;emsp;本文将在C#中Socket同步通信的基础上，分析和研究Socket异步编程的实现方法，目的是深入了解Socket编程的基本原理，增强对网络游戏开发相关内容的认识。">
<meta name="keywords" content="Socket,通信,异步">
<meta property="og:type" content="article">
<meta property="og:title" content="C#中Socket通信编程的异步实现">
<meta property="og:url" content="http://qinyuanpei.github.io/2015/03/22/csharp-socket-programing-part-2.html">
<meta property="og:site_name" content="飞鸿踏雪的部落格">
<meta property="og:description" content="&amp;emsp;&amp;emsp;本文将在C#中Socket同步通信的基础上，分析和研究Socket异步编程的实现方法，目的是深入了解Socket编程的基本原理，增强对网络游戏开发相关内容的认识。">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://7wy477.com1.z0.glb.clouddn.com/imgs_Socket异步通信效果演示.png">
<meta property="og:updated_time" content="2017-11-29T02:27:12.476Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="C#中Socket通信编程的异步实现">
<meta name="twitter:description" content="&amp;emsp;&amp;emsp;本文将在C#中Socket同步通信的基础上，分析和研究Socket异步编程的实现方法，目的是深入了解Socket编程的基本原理，增强对网络游戏开发相关内容的认识。">
<meta name="twitter:image" content="http://7wy477.com1.z0.glb.clouddn.com/imgs_Socket异步通信效果演示.png">
  
    <link rel="alternative" href="/atom.xml" title="飞鸿踏雪的部落格" type="application/atom+xml">
  
  <meta name="summary" content="&lt;p&gt;&amp;emsp;&amp;emsp;本文将在C#中Socket同步通信的基础上，分析和研究Socket异步编程的实现方法，目的是深入了解Socket编程的基本原理，增强对网络游戏开发相关内容的认识。&lt;/p&gt;">
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="stylesheet" href="/assets/styles/style.css">
</head>

<body>
  <div id="loading" class="active"></div>

  <nav id="menu" class="hide" >
   <div class="inner flex-row-vertical">
  <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
      <i class="icon icon-lg icon-close"></i>
  </a>
  <div class="brand-wrap">
    <div class="brand">
      <a href="/" class="avatar"><img src="/assets/images/avatar.jpg"></a>
      <hgroup class="introduce">
        <h5 class="nickname">Payne</h5>
        <a href="mailto:qinyuanpei@163.com" title="qinyuanpei@163.com" class="mail">qinyuanpei@163.com</a>
      </hgroup>
    </div>
  </div>
  <div class="scroll-wrap flex-col">
    <ul class="nav">
      
          <li class="waves-block waves-effect">
            <a href="/"  >
              <i class="icon icon-lg icon-home"></i>
              首页
            </a>
          </li>
      
          <li class="waves-block waves-effect">
            <a href="/archives"  >
              <i class="icon icon-lg icon-archives"></i>
              归档
            </a>
          </li>
      
          <li class="waves-block waves-effect">
            <a href="/tags"  >
              <i class="icon icon-lg icon-tags"></i>
              标签
            </a>
          </li>
      
          <li class="waves-block waves-effect">
            <a href="/about"  >
              <i class="icon icon-lg icon-user"></i>
              关于
            </a>
          </li>
      
    </ul>
    <footer class="footer">
	<p><a rel="license" target="_blank" href="http://creativecommons.org/licenses/by-nc-nd/4.0/">
	<img alt="Creative Commons License" style="border-width:0;vertical-align:middle;" src="/assets/images/cc-by-nc-nd.svg" /></a></p>
	<p>飞鸿踏雪的部落格 &copy;2014~2017.</p>
	<p>Power by <a target="_blank" href="https://hexo.io/">Hexo</a> & Theme <a target="_blank" href="https://github.com/yscoder/hexo-theme-indigo">Indigo</a></p>
	<a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-2x icon-rss-square"></i></a>
</footer>
  </div>
</div>

  </nav>
  <main id="main">
    <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">C#中Socket通信编程的异步实现</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input " autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-share">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header">
  <div class="container">
    <h1 class="author">C#中Socket通信编程的异步实现</h1>
    <h5 class="subtitle">
        
            <time datetime="2015-03-22T09:37:04.000Z" itemprop="datePublished" class="page-time">
  2015-03-22
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/编程语言/">编程语言</a></li></ul>

        
    </h5>
  </div>
</header>

    <div class="container body-wrap">
      <article id="post-csharp-socket-programing-part-2" 
  class="article article-type-post" itemprop="blogPost">
    <div class="post-meta flex-row">
        
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Socket/">Socket</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/异步/">异步</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/通信/">通信</a></li></ul>

    </div>
    <div class="post-body">
        <aside class="post-widget" id="post-widget">

            
            <div class="post-share" id="post-share">
    <div class="tit">分享到：</div>
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" href="javascript:;" data-title="微博" data-service="tsina">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns" href="javascript:;" data-title="微信" data-service="weixin">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" href="javascript:;" data-title=" QQ" data-service="cqq">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="zhihu share-sns" href="javascript:;" data-title="知乎" data-service="zhihu">
          知
        </a>
      </li>
      <li>
        <a class="jianshu share-sns" href="javascript:;" data-title="简书" data-service="jianshu">
          简
        </a>
      </li>
      <li>
        <a class="douban share-sns" href="javascript:;" data-title="豆瓣" data-service="douban">
          豆
        </a>
      </li>
    </ul>
 </div>

            

            
            <nav class="post-toc-wrap" id="post-toc">
            <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#什么是Socket编程的异步的实现"><span class="post-toc-number">1.</span> <span class="post-toc-text">什么是Socket编程的异步的实现</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#如何实现Socket异步通信"><span class="post-toc-number">2.</span> <span class="post-toc-text">如何实现Socket异步通信</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#服务端"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">服务端</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#基本流程"><span class="post-toc-number">2.1.1.</span> <span class="post-toc-text">基本流程</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#代码示例"><span class="post-toc-number">2.1.2.</span> <span class="post-toc-text">代码示例</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#客户端"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">客户端</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#基本流程-1"><span class="post-toc-number">2.2.1.</span> <span class="post-toc-text">基本流程</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#代码示例-1"><span class="post-toc-number">2.2.2.</span> <span class="post-toc-text">代码示例</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#总结"><span class="post-toc-number">3.</span> <span class="post-toc-text">总结</span></a></li></ol>
            </nav>
            
            
        </aside>

        <div class="post-main">

            <div class="post-content" id="post-content" itemprop="postContent">
            <p>&emsp;&emsp;本文将在C#中Socket同步通信的基础上，分析和研究Socket异步编程的实现方法，目的是深入了解Socket编程的基本原理，增强对网络游戏开发相关内容的认识。</p>
<a id="more"></a>
<h1 id="什么是Socket编程的异步的实现"><a href="#什么是Socket编程的异步的实现" class="headerlink" title="什么是Socket编程的异步的实现"></a>什么是Socket编程的异步的实现</h1><p>&emsp;&emsp;所谓Socket编程的异步实现是指按照异步过程来实现Socket编程，那么什么是异步过程呢，我们把在完成了一次调用后通过状态、通知和回调来告知调用者的方式成为异步过程，换句话说，在异步过程中当调用一个方法时，调用者并不能够立刻得到结果，只有当这个方法调用完毕后调用者才能获得调用结果。这样做的好处是什么呢？答案是高效。相信大家还记得我们在《C#中Socket通信编程的同步实现》这篇文章中使用多线程来实现简单聊天的案例吧，在这个案例中我们需要开启两个线程来不断监听客户端的连接和客户端的消息，这样的效率肯定是很低的。那么现在好了，我们可以通过异步过程来解决这个问题，下面我们就来看看如何实现Socket的异步通信。</p>
<h1 id="如何实现Socket异步通信"><a href="#如何实现Socket异步通信" class="headerlink" title="如何实现Socket异步通信"></a>如何实现Socket异步通信</h1><h2 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h2><h3 id="基本流程"><a href="#基本流程" class="headerlink" title="基本流程"></a>基本流程</h3><ul>
<li>创建套接字</li>
<li>绑定套接字的IP和端口号——Bind()</li>
<li>使套接字处于监听状态等待客户端的连接请求——Listen()</li>
<li>当请求到来后，使用BeginAccept()和EndAccept()方法接受请求，返回新的套接字</li>
<li>使用BeginSend()/EndSend和BeginReceive()/EndReceive()两组方法与客户端进行收发通信</li>
<li>返回，再次等待新的连接请求</li>
<li>关闭套接字</li>
</ul>
<h3 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">using System;</span><br><span class="line">using System.Collections.Generic;</span><br><span class="line">using System.Text;</span><br><span class="line">using System.Net;</span><br><span class="line">using System.Net.Sockets;</span><br><span class="line"></span><br><span class="line">namespace AsyncServer</span><br><span class="line">&#123;</span><br><span class="line">    public class AsyncTCPServer</span><br><span class="line">    &#123;</span><br><span class="line">        public void Start()</span><br><span class="line">        &#123;</span><br><span class="line">            //创建套接字</span><br><span class="line">            IPEndPoint ipe = new IPEndPoint(IPAddress.Parse(&quot;127.0.0.1&quot;), 6065);</span><br><span class="line">            Socket socket = new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);</span><br><span class="line">            //绑定端口和IP</span><br><span class="line">            socket.Bind(ipe);</span><br><span class="line">            //设置监听</span><br><span class="line">            socket.Listen(10);</span><br><span class="line">            //连接客户端</span><br><span class="line">            AsyncAccept(socket);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        /// &lt;summary&gt;</span><br><span class="line">        /// 连接到客户端</span><br><span class="line">        /// &lt;/summary&gt;</span><br><span class="line">        /// &lt;param name=&quot;socket&quot;&gt;&lt;/param&gt;</span><br><span class="line">        private void AsyncAccept(Socket socket)</span><br><span class="line">        &#123;</span><br><span class="line">            socket.BeginAccept(asyncResult =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                //获取客户端套接字</span><br><span class="line">                Socket client = socket.EndAccept(asyncResult);</span><br><span class="line">                Console.WriteLine(string.Format(&quot;客户端&#123;0&#125;请求连接...&quot;, client.RemoteEndPoint));</span><br><span class="line">                AsyncSend(client, &quot;服务器收到连接请求&quot;);</span><br><span class="line">                AsyncSend(client, string.Format(&quot;欢迎你&#123;0&#125;&quot;,client.RemoteEndPoint));</span><br><span class="line">                AsyncReveive(client);</span><br><span class="line">            &#125;, null);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        /// &lt;summary&gt;</span><br><span class="line">        /// 接收消息</span><br><span class="line">        /// &lt;/summary&gt;</span><br><span class="line">        /// &lt;param name=&quot;client&quot;&gt;&lt;/param&gt;</span><br><span class="line">        private void AsyncReveive(Socket socket)</span><br><span class="line">        &#123;</span><br><span class="line">            byte[] data = new byte[1024];</span><br><span class="line">            try</span><br><span class="line">            &#123;</span><br><span class="line">                //开始接收消息</span><br><span class="line">                socket.BeginReceive(data, 0, data.Length, SocketFlags.None,</span><br><span class="line">                asyncResult =&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    int length = socket.EndReceive(asyncResult);</span><br><span class="line">                    Console.WriteLine(string.Format(&quot;客户端发送消息:&#123;0&#125;&quot;, Encoding.UTF8.GetString(data)));</span><br><span class="line">                &#125;, null);</span><br><span class="line">            &#125;</span><br><span class="line">            catch (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(ex.Message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        /// &lt;summary&gt;</span><br><span class="line">        /// 发送消息</span><br><span class="line">        /// &lt;/summary&gt;</span><br><span class="line">        /// &lt;param name=&quot;client&quot;&gt;&lt;/param&gt;</span><br><span class="line">        /// &lt;param name=&quot;p&quot;&gt;&lt;/param&gt;</span><br><span class="line">        private void AsyncSend(Socket client, string p)</span><br><span class="line">        &#123;</span><br><span class="line">            if (client == null || p == string.Empty) return;</span><br><span class="line">            //数据转码</span><br><span class="line">            byte[] data = new byte[1024];</span><br><span class="line">            data = Encoding.UTF8.GetBytes(p);</span><br><span class="line">            try</span><br><span class="line">            &#123;</span><br><span class="line">                //开始发送消息</span><br><span class="line">                client.BeginSend(data, 0, data.Length, SocketFlags.None, asyncResult =&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    //完成消息发送</span><br><span class="line">                    int length = client.EndSend(asyncResult);</span><br><span class="line">                    //输出消息</span><br><span class="line">                    Console.WriteLine(string.Format(&quot;服务器发出消息:&#123;0&#125;&quot;, p));</span><br><span class="line">                &#125;, null);</span><br><span class="line">            &#125;</span><br><span class="line">            catch (Exception e)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(e.Message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h2><h3 id="基本流程-1"><a href="#基本流程-1" class="headerlink" title="基本流程"></a>基本流程</h3><ul>
<li>创建套接字并保证与服务器的端口一致</li>
<li>使用BeginConnect()和EndConnect()这组方法向服务端发送连接请求</li>
<li>使用BeginSend()/EndSend和BeginReceive()/EndReceive()两组方法与服务端进行收发通信</li>
<li>关闭套接字</li>
</ul>
<h3 id="代码示例-1"><a href="#代码示例-1" class="headerlink" title="代码示例"></a>代码示例</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">using System;</span><br><span class="line">using System.Collections.Generic;</span><br><span class="line">using System.Text;</span><br><span class="line">using System.Net;</span><br><span class="line">using System.Net.Sockets;</span><br><span class="line"></span><br><span class="line">namespace AsyncClient</span><br><span class="line">&#123;</span><br><span class="line">    public class AsyncTCPClient</span><br><span class="line">    &#123;</span><br><span class="line">        /// &lt;summary&gt;</span><br><span class="line">        /// 连接到服务器</span><br><span class="line">        /// &lt;/summary&gt;</span><br><span class="line">        public void AsynConnect()</span><br><span class="line">        &#123;</span><br><span class="line">            //端口及IP</span><br><span class="line">            IPEndPoint ipe = new IPEndPoint(IPAddress.Parse(&quot;127.0.0.1&quot;), 6065);</span><br><span class="line">            //创建套接字</span><br><span class="line">            Socket client = new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);</span><br><span class="line">            //开始连接到服务器</span><br><span class="line">            client.BeginConnect(ipe, asyncResult =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                client.EndConnect(asyncResult);</span><br><span class="line">                //向服务器发送消息</span><br><span class="line">                AsynSend(client,&quot;你好我是客户端&quot;);</span><br><span class="line">                AsynSend(client, &quot;第一条消息&quot;);</span><br><span class="line">                AsynSend(client, &quot;第二条消息&quot;);</span><br><span class="line">                //接受消息</span><br><span class="line">                AsynRecive(client);</span><br><span class="line">            &#125;, null);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        /// &lt;summary&gt;</span><br><span class="line">        /// 发送消息</span><br><span class="line">        /// &lt;/summary&gt;</span><br><span class="line">        /// &lt;param name=&quot;socket&quot;&gt;&lt;/param&gt;</span><br><span class="line">        /// &lt;param name=&quot;message&quot;&gt;&lt;/param&gt;</span><br><span class="line">        public void AsynSend(Socket socket, string message)</span><br><span class="line">        &#123;</span><br><span class="line">            if (socket == null || message == string.Empty) return;</span><br><span class="line">            //编码</span><br><span class="line">            byte[] data = Encoding.UTF8.GetBytes(message);</span><br><span class="line">            try</span><br><span class="line">            &#123;</span><br><span class="line">                socket.BeginSend(data, 0, data.Length, SocketFlags.None, asyncResult =&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    //完成发送消息</span><br><span class="line">                    int length = socket.EndSend(asyncResult);</span><br><span class="line">                    Console.WriteLine(string.Format(&quot;客户端发送消息:&#123;0&#125;&quot;, message));</span><br><span class="line">                &#125;, null);</span><br><span class="line">            &#125;</span><br><span class="line">            catch (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(&quot;异常信息：&#123;0&#125;&quot;, ex.Message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        /// &lt;summary&gt;</span><br><span class="line">        /// 接收消息</span><br><span class="line">        /// &lt;/summary&gt;</span><br><span class="line">        /// &lt;param name=&quot;socket&quot;&gt;&lt;/param&gt;</span><br><span class="line">        public void AsynRecive(Socket socket)</span><br><span class="line">        &#123;</span><br><span class="line">            byte[] data = new byte[1024];</span><br><span class="line">            try</span><br><span class="line">            &#123;</span><br><span class="line">                //开始接收数据</span><br><span class="line">                socket.BeginReceive(data, 0, data.Length, SocketFlags.None,</span><br><span class="line">                asyncResult =&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    int length = socket.EndReceive(asyncResult);</span><br><span class="line">                    Console.WriteLine(string.Format(&quot;收到服务器消息:&#123;0&#125;&quot;, Encoding.UTF8.GetString(data)));</span><br><span class="line">                    AsynRecive(socket);</span><br><span class="line">                &#125;, null);</span><br><span class="line">            &#125;</span><br><span class="line">            catch (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(&quot;异常信息：&quot;, ex.Message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从总体上来讲Socket异步编程的逻辑性更加明确了，因为我们只需要为每一个过程写好回调函数就好了。那么这个示例的效果如何呢？我们来看看它的演示效果：</p>
<p><img src="http://7wy477.com1.z0.glb.clouddn.com/imgs_Socket异步通信效果演示.png" alt="Socket异步编程效果演示"></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>&emsp;&emsp;和Socket同步编程的案例相比，今天的这个案例可能只是对Socket异步编程内容的一个简单应用，因为博主到现在为止都还没有写出一个可以进行交互聊天的程序来。在Socket的异步编程中，服务端不需要为一个客户端单独创建一个线程来维护其连接，可是这样带来的一个问题就是博主不知道该如何实现一个多客户端的异步编程的实例。如果有朋友知道如何实现的话，还希望能够告诉我，毕竟学习就是一个相互促进的过程啊。好了，最后想说的是博主这段时间研究Socket异步编程中关于异步方法调用的写法问题。我们知道Socket异步编程中的方法是成对出现的，每一个方法都有一个回调函数，对于回调函数，这里有两种写法，以BeginConnect方法为例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">m_Socket.BeginConnect(this.m_ipEndPoint, </span><br><span class="line">        new AsyncCallback(this.ConnectCallBack), </span><br><span class="line">        this.m_Socket);//其中ConnectCallBack是一个回调函数</span><br></pre></td></tr></table></figure></p>
<p>或者<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">m_Socket.BeginConnect(this.m_ipEndPoint,asyncResult=&gt;</span><br><span class="line">&#123;</span><br><span class="line">    //在这里添加更多代码</span><br><span class="line">&#125;,null)</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;博主为什么要在这里说这两种写法呢，有两个原因：</p>
<ul>
<li>第二种写法更为简洁，无需去构造容器传递Socket和消息，因为它们都是局部变量。如果我们使用第一种方法，因为主函数和回调函数是两个不同的函数，因此如果想要共享变量就需要通过IAsyncResult接口来访问容器中的值，这样显然增加了我们的工作量。</li>
<li>第二种写法更为优雅，这似乎是C#语言中某种高级语法，具体叫什么我忘了，反正在Linq中经常看到这种写法的影子。</li>
</ul>
<p>&emsp;&emsp;综合以上两个观点，博主还是建议大家使用第二种写法，博主打算有空的话将之前写的程序再重新写一遍，看看能不能找出代码中的问题。好了，今天的内容就是这样了，谢谢大家，希望大家喜欢！</p>


            
            <div class="post-reward">
                <a id="rewardBtn" href="javascript:;" class="post-reward-btn waves-effect waves-circle waves-light">赏</a>
            </div>
            
            
            <blockquote>
                <p><b>版权声明：</b>
                <a href="http://qinyuanpei.github.io/2015/03/22/csharp-socket-programing-part-2.html" rel="external">C#中Socket通信编程的异步实现</a>
                ，由&nbsp;<a href="/about" target="_blank" rel="external">Payne</a>&nbsp;
                首次发表于&nbsp;<a href="/" target="_blank" rel="external">飞鸿踏雪的部落格</a>&nbsp;
                ，本文地址为：
                <a href="http://qinyuanpei.github.io/2015/03/22/csharp-socket-programing-part-2.html" target="_blank" rel="external">http://qinyuanpei.github.io/2015/03/22/csharp-socket-programing-part-2.html</a>
                ，转载请注明<b>作者</b>和<b>出处</b>。
                </p>
            </blockquote>
            </div>
            
<nav class="post-nav">
  
    <div class="waves-block waves-effect prev fl">
      <a href="/2015/03/24/publish-webgame-with-coding-net-and-hexo.html" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">使用Coding.NET和Hexo实现网页游戏的发布</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next fr">
      <a href="/2015/03/15/csharp-socket-programing-part-1.html" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">C#中Socket通信编程的同步实现</h4>
      </a>
    </div>
  
</nav>


            
            
   
<section class="comments" id="comments">
    <div id="gitment_thread"></div>
    <link rel="stylesheet" href="//unpkg.com/gitment/style/default.css">
    <script src="//unpkg.com/gitment/dist/gitment.browser.js"></script>
    <script>
        var gitment = new Gitment({
            owner: 'qinyuanpei',
            repo: 'qinyuanpei.github.io',
            oauth: {
                client_id: 'bfad13d75d668e9ea9b6',
                client_secret: 'febcfa5a17d192d12717e591c043e80bb4971a2',
            },
        })
        gitment.render('comments')
    </script>
</section>






        </div>
    </div>
</article>

<div id="reward" class="reward-lay">
    <a class="reward-off" id="rewardOff" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        来而不往非礼也
        <i class="icon icon-quote-right"></i>
    </h3>
    <ul class="reward-items">
        
        <li>
            <img src="/assets/images/wechat.png" title="微信打赏二维码" alt="微信打赏二维码">
            <p>微信</p>
        </li>
        

        
        <li>
            <img src="/assets/images/alipay.jpg" title="支付宝打赏二维码" alt="支付宝打赏二维码">
            <p>支付宝</p>
        </li>
        
    </ul>
</div>

    </div>
  </main>
<div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>

<script>
var BLOG_SHARE = {
    title: "C#中Socket通信编程的异步实现",
    pic: "/assets/images/avatar.jpg",
    summary: document.getElementsByName('summary')[0].content,
    url: "http://qinyuanpei.github.io/2015/03/22/csharp-socket-programing-part-2.html"
};
</script>
<div class="global-share" id="global-share">
    <div class="tit">分享到：</div>
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" href="javascript:;" data-title="微博" data-service="tsina">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns" href="javascript:;" data-title="微信" data-service="weixin">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" href="javascript:;" data-title=" QQ" data-service="cqq">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="zhihu share-sns" href="javascript:;" data-title="知乎" data-service="zhihu">
          知
        </a>
      </li>
      <li>
        <a class="jianshu share-sns" href="javascript:;" data-title="简书" data-service="jianshu">
          简
        </a>
      </li>
      <li>
        <a class="douban share-sns" href="javascript:;" data-title="豆瓣" data-service="douban">
          豆
        </a>
      </li>
    </ul>
 </div>


<script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script src="/assets/scripts/main.js"></script>




<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<script type="text/template" id="search-tpl">
<li class="item">
    <a href="/{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</script>

<script src="/assets/scripts/search.js"></script>




</body>
</html>
